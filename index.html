<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>WhatsApp Call - Mobile</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    
    <style>
        :root {
            --bg-color: #111b21;
            --header-color: #202c33;
            --accent-color: #00a884;
            --text-primary: #e9edef;
            --text-secondary: #8696a0;
            --incoming-bg: #0b141a;
        }
        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            font-family: Helvetica, Arial, sans-serif;
            margin: 0; height: 100vh; display: flex; flex-direction: column;
            user-select: none;
        }

        /* HEADER & PROFILE */
        .header {
            background-color: var(--header-color); padding: 15px;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2); font-weight: bold; font-size: 20px; color: var(--text-secondary);
        }
        .header span { color: var(--text-primary); }
        
        .profile-summary {
            display: flex; align-items: center; padding: 15px; background: var(--header-color);
            margin: 10px; border-radius: 10px; border: 1px solid #333; cursor: pointer;
        }
        .my-avatar-small {
            width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 15px; background: #555;
        }

        /* RECENT CALLS LIST */
        #recent-list { flex: 1; overflow-y: auto; }
        .call-item {
            display: flex; align-items: center; padding: 15px;
            cursor: pointer; border-bottom: 1px solid #202c33;
        }
        .call-item:active { background-color: #202c33; }
        .avatar-img {
            width: 50px; height: 50px; border-radius: 50%; object-fit: cover; margin-right: 15px; background: #333;
        }
        .info { flex: 1; }
        .name-row { display: flex; justify-content: space-between; }
        .name { font-size: 17px; font-weight: 500; margin-bottom: 4px; color: var(--text-primary); }
        .status-dot { width: 10px; height: 10px; background: gray; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .status-dot.online { background: #00a884; box-shadow: 0 0 5px #00a884; }
        
        .time { font-size: 13px; color: var(--text-secondary); display: flex; align-items: center; }
        .call-icon { color: var(--accent-color); font-size: 24px; }

        /* FAB & MODALS */
        .fab {
            position: fixed; bottom: 20px; right: 20px; width: 60px; height: 60px;
            background-color: var(--accent-color); border-radius: 50%;
            display: flex; justify-content: center; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.4); cursor: pointer; z-index: 20;
        }
        .fab i { color: white; font-size: 28px; }

        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100; display: none; justify-content: center; align-items: center;
        }
        .modal-box { background: var(--header-color); padding: 25px; width: 85%; max-width: 400px; border-radius: 15px; text-align: center; display: flex; flex-direction: column; align-items: center;}
        
        input { 
            width: 100%; padding: 12px; background: #2a3942; border: none; 
            color: white; border-radius: 8px; margin: 10px 0; font-size: 16px; 
            box-sizing: border-box; text-align: center;
        }
        
        /* New Styles for File Picker */
        .avatar-preview-box {
            width: 80px; height: 80px; border-radius: 50%; background: #333; margin-bottom: 10px;
            object-fit: cover; border: 2px solid var(--accent-color);
        }
        .file-label {
            background: #2a3942; color: var(--text-primary); padding: 8px 15px; border-radius: 20px;
            font-size: 14px; cursor: pointer; margin-bottom: 15px; display: inline-block;
        }

        .modal-btn { padding: 10px 25px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 16px; margin: 5px; width: 100px;}
        .btn-primary { background: var(--accent-color); color: white; }
        .btn-cancel { background: transparent; color: var(--text-secondary); }

        /* INCOMING & VIDEO SCREENS */
        #video-screen, #incoming-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 200; display: none;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        #local-video { position: absolute; bottom: 120px; right: 20px; width: 100px; height: 150px; background: #333; border-radius: 10px; border: 2px solid white; transform: scaleX(-1); }
        .controls { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; gap: 30px; }
        .ctrl-btn { width: 60px; height: 60px; border-radius: 50%; border: none; font-size: 28px; display: flex; justify-content: center; align-items: center; cursor: pointer; color: white; }
        .btn-end { background: #f44336; }
        
        #incoming-screen { background: var(--incoming-bg); flex-direction: column; align-items: center; justify-content: center; }
        .avatar-large { 
            width: 120px; height: 120px; border-radius: 50%; margin-bottom: 20px; object-fit: cover;
            border: 2px solid var(--accent-color); animation: pulse 1.5s infinite; 
        }
        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 168, 132, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 20px rgba(0, 168, 132, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(0, 168, 132, 0); } }
    </style>
</head>
<body>

    <div class="header">
        <span>WhatsApp Call</span>
        <i class="material-icons" onclick="reqNotify()" style="cursor:pointer;">notifications</i>
    </div>

    <div class="profile-summary" onclick="openProfileModal()">
        <img src="" id="disp-my-avatar" class="my-avatar-small" onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'">
        <div style="text-align: left;">
            <div id="disp-my-name" style="font-weight: bold; font-size: 18px;">Set Your Profile</div>
            <div style="font-size: 12px; color: var(--accent-color);">Mobile: <span id="disp-my-id">...</span></div>
        </div>
        <div style="flex:1; text-align: right;"><i class="material-icons" style="color: #00a884;">edit</i></div>
    </div>

    <div id="recent-list">
        <div style="text-align: center; padding: 50px; color: #8696a0;">Tap + to call a number.</div>
    </div>

    <div class="fab" onclick="openDialer()"><i class="material-icons">add_call</i></div>

    <div id="profile-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>Profile Setup</h3>
            
            <img id="preview-avatar" class="avatar-preview-box" src="https://cdn-icons-png.flaticon.com/512/149/149071.png">
            <label for="file-upload" class="file-label"><i class="material-icons" style="font-size:16px; vertical-align:middle;">photo_camera</i> Choose Photo</label>
            <input type="file" id="file-upload" accept="image/*" style="display:none" onchange="handleImageUpload(this)">
            
            <input type="text" id="input-name" placeholder="Enter Your Name">
            <input type="number" id="input-custom-id" placeholder="Enter Mobile Number">
            <p style="font-size:11px; color:#777;">Note: App will reload when number changes.</p>
            <div>
                <button class="modal-btn btn-cancel" onclick="closeProfileModal()">Cancel</button>
                <button class="modal-btn btn-primary" onclick="saveProfile()">Save</button>
            </div>
        </div>
    </div>

    <div id="dial-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>Start Call</h3>
            <input type="number" id="input-partner-id" placeholder="Enter Partner Mobile No.">
            <div>
                <button class="modal-btn btn-cancel" onclick="closeDialer()">Cancel</button>
                <button class="modal-btn btn-primary" onclick="dialFromInput()">Call</button>
            </div>
        </div>
    </div>

    <div id="incoming-screen">
        <img src="" id="inc-avatar" class="avatar-large" onerror="this.src='https://cdn-icons-png.flaticon.com/512/149/149071.png'">
        <h2 id="inc-name">Unknown</h2>
        <p id="inc-id" style="color: #8696a0;">WhatsApp Video Call</p>
        <div style="display: flex; gap: 50px; margin-top: 50px;">
            <button class="ctrl-btn btn-end" onclick="rejectCall()"><i class="material-icons">call_end</i></button>
            <button class="ctrl-btn" style="background: #00a884;" onclick="acceptCall()"><i class="material-icons">videocam</i></button>
        </div>
    </div>

    <div id="video-screen">
        <video id="remote-video" autoplay playsinline></video>
        <video id="local-video" autoplay muted playsinline></video>
        <div class="controls"><button class="ctrl-btn btn-end" onclick="endCall()"><i class="material-icons">call_end</i></button></div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const DEFAULT_AVATAR = 'https://cdn-icons-png.flaticon.com/512/149/149071.png';
        let tempAvatarData = DEFAULT_AVATAR; // Holds the base64 string temporarily

        let myProfile = JSON.parse(localStorage.getItem('wa_profile')) || {
            name: 'New User',
            avatar: DEFAULT_AVATAR,
            id: Math.floor(100000 + Math.random() * 900000).toString() // Temp random ID until set
        };

        // UI Initialization
        document.getElementById('disp-my-name').innerText = myProfile.name;
        document.getElementById('disp-my-id').innerText = myProfile.id;
        document.getElementById('disp-my-avatar').src = myProfile.avatar;
        document.getElementById('preview-avatar').src = myProfile.avatar;
        tempAvatarData = myProfile.avatar;

        // PeerJS Setup
        const peer = new Peer(myProfile.id, { config: { iceServers: [ { urls: 'stun:stun.l.google.com:19302' } ] } });
        let currentCall = null;
        let localStream = null;
        let callHistory = JSON.parse(localStorage.getItem('wa_history_v2')) || [];

        // --- PEER EVENTS ---
        peer.on('open', (id) => { 
            console.log("Connected as: " + id); 
            renderHistory(); 
        });

        peer.on('connection', (conn) => {
            conn.on('data', (data) => {
                if(data.type === 'profile_info') {
                    document.getElementById('inc-name').innerText = data.name;
                    document.getElementById('inc-avatar').src = data.avatar;
                    updateHistoryContact(conn.peer, data.name, data.avatar, true); 
                }
            });
        });

        peer.on('call', (call) => {
            currentCall = call;
            document.getElementById('incoming-screen').style.display = 'flex';
            document.getElementById('inc-id').innerText = "Mobile: " + call.peer;
            document.getElementById('inc-name').innerText = "Incoming Call..."; 
            showNotification(call.peer);
        });

        peer.on('error', (err) => alert("Connection Error: Check internet or ID"));

        // --- IMAGE PROCESSING (COMPRESS TO BASE64) ---
        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    // Create an image to resize it (Canvas)
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = function() {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');
                        // Resize to max 150px to keep storage low
                        const MAX_SIZE = 150; 
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_SIZE) { height *= MAX_SIZE / width; width = MAX_SIZE; }
                        } else {
                            if (height > MAX_SIZE) { width *= MAX_SIZE / height; height = MAX_SIZE; }
                        }
                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        // Get compressed Base64
                        tempAvatarData = canvas.toDataURL('image/jpeg', 0.7);
                        document.getElementById('preview-avatar').src = tempAvatarData;
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        // --- PROFILE MANAGEMENT ---
        function openProfileModal() {
            document.getElementById('input-name').value = myProfile.name;
            document.getElementById('input-custom-id').value = myProfile.id;
            document.getElementById('preview-avatar').src = myProfile.avatar;
            document.getElementById('profile-modal').style.display = 'flex';
        }
        function closeProfileModal() { document.getElementById('profile-modal').style.display = 'none'; }
        
        function saveProfile() {
            const newName = document.getElementById('input-name').value;
            const newId = document.getElementById('input-custom-id').value;
            
            if(newName && newId) {
                const oldId = myProfile.id;
                myProfile.name = newName;
                myProfile.avatar = tempAvatarData; // Save the base64 string
                myProfile.id = newId;

                localStorage.setItem('wa_profile', JSON.stringify(myProfile));
                
                if(oldId !== newId) {
                    location.reload(); // Reload to register new Mobile Number ID
                } else {
                    document.getElementById('disp-my-name').innerText = myProfile.name;
                    document.getElementById('disp-my-avatar').src = myProfile.avatar;
                    document.getElementById('disp-my-id').innerText = myProfile.id;
                    closeProfileModal();
                }
            } else {
                alert("Name and Mobile Number are required!");
            }
        }

        // --- CALL FUNCTIONS ---
        function openDialer() { document.getElementById('dial-modal').style.display = 'flex'; }
        function closeDialer() { document.getElementById('dial-modal').style.display = 'none'; }
        
        function dialFromInput() { 
            const id = document.getElementById('input-partner-id').value; 
            if(id) { closeDialer(); startCall(id); }
        }

        function startCall(partnerID) {
            if(partnerID === myProfile.id) return alert("You cannot call your own number.");
            
            // Connect to send info
            const conn = peer.connect(partnerID);
            conn.on('open', () => {
                conn.send({ type: 'profile_info', name: myProfile.name, avatar: myProfile.avatar });
            });

            document.getElementById('video-screen').style.display = 'block';
            updateHistoryContact(partnerID, partnerID, DEFAULT_AVATAR, false);

            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then((stream) => {
                localStream = stream; document.getElementById('local-video').srcObject = stream;
                const call = peer.call(partnerID, stream); 
                currentCall = call;
                call.on('stream', (remoteStream) => { document.getElementById('remote-video').srcObject = remoteStream; });
                call.on('close', endCall);
            }).catch(err => alert("Camera blocked or not found."));
        }

        function acceptCall() {
            document.getElementById('incoming-screen').style.display = 'none';
            document.getElementById('video-screen').style.display = 'block';
            
            const conn = peer.connect(currentCall.peer);
            conn.on('open', () => {
                conn.send({ type: 'profile_info', name: myProfile.name, avatar: myProfile.avatar });
            });

            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then((stream) => {
                localStream = stream; document.getElementById('local-video').srcObject = stream;
                currentCall.answer(stream);
                currentCall.on('stream', (remoteStream) => { document.getElementById('remote-video').srcObject = remoteStream; });
                currentCall.on('close', endCall);
            });
        }

        function rejectCall() { if(currentCall) currentCall.close(); document.getElementById('incoming-screen').style.display = 'none'; }
        function endCall() { if(currentCall) currentCall.close(); if(localStream) localStream.getTracks().forEach(t => t.stop()); document.getElementById('video-screen').style.display = 'none'; window.location.reload(); }

        // --- UTILS ---
        function reqNotify() {
            if (!("Notification" in window)) return alert("Not supported.");
            Notification.requestPermission().then(permission => { if (permission === "granted") alert("Notifications Enabled!"); });
        }
        function showNotification(callerId) {
            if (Notification.permission === "granted") {
                new Notification("Incoming Call", { body: `Call from ${callerId}`, icon: 'https://cdn-icons-png.flaticon.com/512/724/724664.png' });
            }
        }

        function updateHistoryContact(id, name, avatar, isOnline) {
            const index = callHistory.findIndex(i => i.id === id);
            const entry = {
                id: id,
                name: (name === id) ? (index > -1 ? callHistory[index].name : id) : name,
                avatar: (avatar === DEFAULT_AVATAR) ? (index > -1 ? callHistory[index].avatar : DEFAULT_AVATAR) : avatar,
                time: new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}),
                isOnline: isOnline
            };
            if(index > -1) callHistory.splice(index, 1);
            callHistory.unshift(entry);
            localStorage.setItem('wa_history_v2', JSON.stringify(callHistory));
            renderHistory();
        }

        function renderHistory() {
            const list = document.getElementById('recent-list');
            list.innerHTML = '';
            if(callHistory.length === 0) return list.innerHTML = '<div style="text-align: center; padding: 50px; color: #8696a0;">Tap + to call a number.</div>';
            
            callHistory.forEach(item => {
                const div = document.createElement('div'); div.className = 'call-item'; div.onclick = () => startCall(item.id);
                div.innerHTML = `
                    <img src="${item.avatar}" class="avatar-img" onerror="this.src='${DEFAULT_AVATAR}'">
                    <div class="info">
                        <div class="name-row"><div class="name">${item.name}</div></div>
                        <div class="time"><span class="status-dot ${item.isOnline ? 'online' : ''}"></span>${item.isOnline ? 'Online' : item.time}</div>
                    </div>
                    <i class="material-icons call-icon">videocam</i>`;
                list.appendChild(div);
            });
        }
    </script>
</body>
</html>
